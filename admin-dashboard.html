<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard | Personal Website</title>
  <style>
    :root {
      --primary-color: #3b82f6;
      --primary-hover: #2563eb;
      --text-color: #333;
      --bg-color: #f5f7fa;
      --card-bg: #fff;
      --border-color: #e5e7eb;
      --success-color: #22c55e;
      --error-color: #ef4444;
      --warning-color: #f59e0b;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      line-height: 1.6;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 0;
      border-bottom: 1px solid var(--border-color);
      margin-bottom: 30px;
    }
    
    .header h1 {
      color: var(--primary-color);
      font-size: 24px;
    }
    
    .user-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      background-color: var(--card-bg);
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      padding: 20px;
      text-align: center;
    }
    
    .stat-card h3 {
      font-size: 14px;
      color: #6b7280;
      margin-bottom: 10px;
    }
    
    .stat-card .value {
      font-size: 24px;
      font-weight: 700;
      color: var(--primary-color);
    }
    
    .tabs {
      display: flex;
      gap: 5px;
      margin-bottom: 20px;
      border-bottom: 1px solid var(--border-color);
    }
    
    .tab {
      padding: 10px 15px;
      cursor: pointer;
      border-bottom: 2px solid transparent;
    }
    
    .tab.active {
      border-bottom: 2px solid var(--primary-color);
      color: var(--primary-color);
      font-weight: 500;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .card {
      background-color: var(--card-bg);
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      padding: 20px;
      margin-bottom: 20px;
    }
    
    button {
      background-color: var(--primary-color);
      color: white;
      border: none;
      padding: 12px;
      border-radius: 4px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    button:hover {
      background-color: var(--primary-hover);
    }
    
    button:disabled {
      background-color: #93c5fd;
      cursor: not-allowed;
    }
    
    .secondary-button {
      background-color: #6b7280;
    }
    
    .secondary-button:hover {
      background-color: #4b5563;
    }
    
    .table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .table th, .table td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid var(--border-color);
    }
    
    .table th {
      background-color: #f8fafc;
      font-weight: 600;
      color: #6b7280;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
    }
    
    input, select, textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      font-size: 16px;
    }
    
    textarea {
      resize: vertical;
      min-height: 100px;
    }
    
    .alert {
      padding: 12px 15px;
      border-radius: 4px;
      margin-bottom: 20px;
    }
    
    .alert-error {
      background-color: #fee2e2;
      color: var(--error-color);
      border-left: 4px solid var(--error-color);
    }
    
    .alert-success {
      background-color: #dcfce7;
      color: var(--success-color);
      border-left: 4px solid var(--success-color);
    }
    
    .hidden {
      display: none;
    }
    
    .book-form {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    
    .action-buttons {
      display: flex;
      gap: 10px;
    }
    
    .btn-small {
      padding: 6px 12px;
      font-size: 14px;
    }
    
    .btn-edit {
      background-color: #f59e0b;
    }
    
    .btn-edit:hover {
      background-color: #d97706;
    }
    
    .btn-delete {
      background-color: #ef4444;
    }
    
    .btn-delete:hover {
      background-color: #dc2626;
    }
    
    #statusMessage {
      padding: 12px 15px;
      border-radius: 4px;
      margin: 20px 0;
      display: none;
    }
    
    .auth-check {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: var(--bg-color);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    
    .auth-check h2 {
      color: var(--primary-color);
      margin-bottom: 10px;
    }
    
    .loader {
      border: 4px solid #f3f3f3;
      border-top: 4px solid var(--primary-color);
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <!-- Auth Check Screen -->
  <div id="authCheck" class="auth-check">
    <div class="loader"></div>
    <h2>Verifying Authentication</h2>
    <p>Please wait while we verify your credentials.</p>
    <div id="authMessage" style="margin-top: 15px;"></div>
  </div>
  
  <!-- Admin Dashboard -->
  <div id="adminDashboard" class="container" style="display: none;">
    <div class="header">
      <h1>Admin Dashboard</h1>
      <div class="user-info">
        <span id="userEmail"></span>
        <button id="logoutButton" class="btn-small">Logout</button>
      </div>
    </div>
    
    <div class="dashboard-grid">
      <div class="stat-card">
        <h3>Total Books</h3>
        <div class="value" id="totalBooks">0</div>
      </div>
      <div class="stat-card">
        <h3>Categories</h3>
        <div class="value" id="totalCategories">0</div>
      </div>
      <div class="stat-card">
        <h3>Fiction Books</h3>
        <div class="value" id="fictionBooks">0</div>
      </div>
      <div class="stat-card">
        <h3>Non-Fiction Books</h3>
        <div class="value" id="nonFictionBooks">0</div>
      </div>
    </div>
    
    <div class="tabs">
      <div class="tab active" data-tab="bookList">Book Management</div>
      <div class="tab" data-tab="addBook">Add New Book</div>
      <div class="tab" data-tab="blogManagement">Blog Management</div>
      <div class="tab" data-tab="siteAdmin">Site Analytics</div>
    </div>
    
    <div id="statusMessage"></div>
    
    <div id="bookListTab" class="tab-content active">
      <div class="card">
        <h2>Book Collection</h2>
        <div id="booksTableContainer">
          <table class="table" id="booksTable">
            <thead>
              <tr>
                <th>Title</th>
                <th>Author</th>
                <th>Category</th>
                <th>Year</th>
                <th>Status</th>
                <th>Rating</th>
                <th>ISBN</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="booksTableBody">
              <!-- Books will be loaded here -->
              <tr>
                <td colspan="8" style="text-align: center;">No books found. Add some books to see them here.</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    
    <div id="addBookTab" class="tab-content">
      <div class="card">
        <h2>Add New Book</h2>
        
        <!-- Book Search Options -->
        <div class="search-options" style="margin-bottom: 20px;">
          <div style="display: flex; margin-bottom: 15px;">
            <button type="button" id="searchByIsbnBtn" class="search-tab active" style="flex: 1; padding: 8px; border: none; border-radius: 4px 0 0 4px; cursor: pointer; background-color: var(--primary-color); color: white;">Search by ISBN</button>
            <button type="button" id="searchByTitleBtn" class="search-tab" style="flex: 1; padding: 8px; border: none; border-radius: 0 4px 4px 0; cursor: pointer; background-color: #e5e7eb; color: var(--text-color);">Search by Title/Author</button>
          </div>
          
          <!-- ISBN Search -->
          <div id="isbnSearchContainer" class="search-container" style="margin-bottom: 20px;">
            <div style="display: flex;">
              <input type="text" id="isbnSearch" placeholder="Enter ISBN (e.g., 9780061122415)" style="flex-grow: 1; padding: 10px; border: 1px solid var(--border-color); border-radius: 4px 0 0 4px;">
              <button type="button" id="isbnSearchBtn" style="padding: 10px 15px; border: none; border-radius: 0 4px 4px 0; background-color: var(--primary-color); color: white; cursor: pointer;">Lookup</button>
            </div>
          </div>
          
          <!-- Title/Author Search -->
          <div id="titleSearchContainer" class="search-container" style="display: none; margin-bottom: 20px;">
            <div style="display: flex;">
              <input type="text" id="titleSearch" placeholder="Enter title or author name" style="flex-grow: 1; padding: 10px; border: 1px solid var(--border-color); border-radius: 4px 0 0 4px;">
              <button type="button" id="titleSearchBtn" style="padding: 10px 15px; border: none; border-radius: 0 4px 4px 0; background-color: var(--primary-color); color: white; cursor: pointer;">Search</button>
            </div>
          </div>
        </div>
        
        <!-- Search Results -->
        <div id="searchResults" style="display: none; max-height: 300px; overflow-y: auto; margin-bottom: 20px; border: 1px solid var(--border-color); border-radius: 4px;">
          <div id="searchResultsList"></div>
        </div>
        
        <!-- Book Preview -->
        <div id="bookPreview" style="display: none; margin-bottom: 20px; padding: 15px; background-color: #f8f9fa; border-radius: 4px;">
          <div style="display: flex; align-items: start;">
            <div id="bookPreviewCover" style="width: 80px; height: 120px; background-color: #ddd; margin-right: 15px; text-align: center; line-height: 120px; font-size: 10px;">No Cover</div>
            <div>
              <h3 id="bookPreviewTitle" style="margin: 0 0 5px 0; font-size: 18px;">Book Title</h3>
              <p id="bookPreviewAuthor" style="margin: 0 0 5px 0; font-size: 14px; color: #666;">Author Name</p>
              <p id="bookPreviewPublisher" style="margin: 0; font-size: 12px; color: #666;">Publisher, Year</p>
              <p id="bookPreviewIsbn" style="margin: 5px 0 0 0; font-size: 12px; color: #666;">ISBN: 1234567890</p>
            </div>
          </div>
          <div id="bookPreviewDescription" style="margin-top: 15px; font-size: 14px; max-height: 100px; overflow-y: auto;"></div>
        </div>
        
        <!-- Manual Book Form -->
        <form id="bookForm" class="book-form">
          <div class="form-group">
            <label for="title">Title</label>
            <input type="text" id="title" required>
          </div>
          
          <div class="form-group">
            <label for="author">Author</label>
            <input type="text" id="author" required>
          </div>
          
          <div class="form-group">
            <label for="category">Category</label>
            <input type="text" id="category" required placeholder="e.g. Fiction, Science, History">
          </div>
          
          <div class="form-group">
            <label for="year">Year Published</label>
            <input type="number" id="year" required min="1000" max="2100">
          </div>
          
          <div class="form-group">
            <label for="status">Reading Status</label>
            <select id="status" required>
              <option value="read">Read</option>
              <option value="reading">Currently Reading</option>
              <option value="toRead">Want to Read</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="userRating">My Rating</label>
            <select id="userRating">
              <option value="">-- Select Rating --</option>
              <option value="5">★★★★★ (5/5) - Excellent</option>
              <option value="4">★★★★☆ (4/5) - Very Good</option>
              <option value="3">★★★☆☆ (3/5) - Good</option>
              <option value="2">★★☆☆☆ (2/5) - Fair</option>
              <option value="1">★☆☆☆☆ (1/5) - Poor</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="notes">My Notes & Review</label>
            <textarea id="notes" rows="4" placeholder="Your personal thoughts, reviews, or notes about the book..."></textarea>
          </div>
          
          <div class="form-group">
            <label for="description">Book Description</label>
            <textarea id="description" rows="4"></textarea>
          </div>
          
          <div class="form-group">
            <label for="coverImage">Cover Image URL</label>
            <input type="url" id="coverImage" placeholder="https://example.com/book-cover.jpg">
          </div>
          
          <input type="hidden" id="bookId">
          <input type="hidden" id="bookIsbn">
          <button type="submit" id="saveBookButton">Save Book</button>
        </form>
      </div>
    </div>
    
    <div id="blogManagementTab" class="tab-content">
      <div class="card">
        <h2>Blog Management</h2>
        
        <div class="tabs mt-4" style="border-bottom: 1px solid #e5e7eb;">
          <div class="tab active" data-blog-tab="postList">All Posts</div>
          <div class="tab" data-blog-tab="newPost">New Post</div>
          <div class="tab" data-blog-tab="categories">Categories</div>
          <div class="tab" data-blog-tab="analytics">Analytics</div>
        </div>
        
        <!-- Post List Tab -->
        <div id="postListTab" class="blog-tab-content active">
          <div style="margin: 20px 0; display: flex; justify-content: space-between; align-items: center;">
            <div>
              <input type="text" id="postSearch" placeholder="Search posts..." style="padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 4px;">
              <select id="postFilter" style="margin-left: 8px; padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 4px;">
                <option value="all">All Posts</option>
                <option value="published">Published</option>
                <option value="draft">Drafts</option>
                <option value="scheduled">Scheduled</option>
              </select>
            </div>
            <button id="newPostBtn" class="btn-small">New Post</button>
          </div>
          
          <table class="table">
            <thead>
              <tr>
                <th>Title</th>
                <th>Status</th>
                <th>Category</th>
                <th>Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="postsTableBody">
              <tr>
                <td colspan="5" style="text-align: center; padding: 20px;">No posts found. Create one to get started!</td>
              </tr>
            </tbody>
          </table>
        </div>
        
        <!-- New Post Tab -->
        <div id="newPostTab" class="blog-tab-content" style="display: none;">
          <form id="postForm" style="margin-top: 20px;">
            <div class="form-group">
              <label for="postTitle">Post Title</label>
              <input type="text" id="postTitle" placeholder="Enter post title..." required>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
              <div class="form-group">
                <label for="postCategory">Category</label>
                <select id="postCategory">
                  <option value="">Select category...</option>
                  <option value="technology">Technology</option>
                  <option value="programming">Programming</option>
                  <option value="design">Design</option>
                  <option value="career">Career</option>
                </select>
              </div>
              
              <div class="form-group">
                <label for="postStatus">Status</label>
                <select id="postStatus">
                  <option value="draft">Draft</option>
                  <option value="published">Published</option>
                  <option value="scheduled">Scheduled</option>
                </select>
              </div>
            </div>
            
            <div id="schedulingOptions" class="form-group" style="display: none;">
              <label for="publishDate">Publish Date</label>
              <input type="datetime-local" id="publishDate">
            </div>
            
            <div class="form-group">
              <label for="postContent">Content</label>
              <div id="editorToolbar" style="border: 1px solid var(--border-color); border-bottom: none; border-radius: 4px 4px 0 0; padding: 8px; background-color: #f8fafc; display: flex; flex-wrap: wrap; gap: 5px;">
                <button type="button" data-format="bold" style="padding: 5px 10px; background-color: white; border: 1px solid var(--border-color); border-radius: 4px;" title="Bold"><b>B</b></button>
                <button type="button" data-format="italic" style="padding: 5px 10px; background-color: white; border: 1px solid var(--border-color); border-radius: 4px;" title="Italic"><i>I</i></button>
                <button type="button" data-format="heading" style="padding: 5px 10px; background-color: white; border: 1px solid var(--border-color); border-radius: 4px;" title="Heading">H</button>
                <button type="button" data-format="link" style="padding: 5px 10px; background-color: white; border: 1px solid var(--border-color); border-radius: 4px;" title="Link">🔗</button>
                <button type="button" data-format="image" style="padding: 5px 10px; background-color: white; border: 1px solid var(--border-color); border-radius: 4px;" title="Image">🖼️</button>
                <button type="button" data-format="code" style="padding: 5px 10px; background-color: white; border: 1px solid var(--border-color); border-radius: 4px;" title="Code">&#60;/&#62;</button>
                <button type="button" data-format="quote" style="padding: 5px 10px; background-color: white; border: 1px solid var(--border-color); border-radius: 4px;" title="Quote">❝</button>
                <button type="button" data-format="list" style="padding: 5px 10px; background-color: white; border: 1px solid var(--border-color); border-radius: 4px;" title="List">• List</button>
              </div>
              <textarea id="postContent" style="border-radius: 0 0 4px 4px; min-height: 300px;" placeholder="Write your post content..."></textarea>
            </div>
            
            <div class="form-group" style="border: 1px solid var(--border-color); border-radius: 4px; padding: 15px; background-color: #f8fafc; margin-bottom: 20px;">
              <h3 style="margin-top: 0; margin-bottom: 15px; font-size: 18px;">SEO Settings</h3>
              
              <div class="form-group">
                <label for="postSlug">Slug</label>
                <div style="display: flex;">
                  <span style="background-color: #e5e7eb; color: #4b5563; padding: 10px; border: 1px solid var(--border-color); border-right: none; border-radius: 4px 0 0 4px;">/blog/</span>
                  <input type="text" id="postSlug" style="border-radius: 0 4px 4px 0;" placeholder="your-post-slug">
                </div>
              </div>
              
              <div class="form-group">
                <label for="metaDescription">Meta Description</label>
                <textarea id="metaDescription" style="height: 80px;" placeholder="Brief description for search engines..."></textarea>
                <div style="font-size: 12px; color: #6b7280; margin-top: 5px;">
                  <span id="metaDescLength">0</span>/160 characters - 
                  <span id="metaDescStatus">Too short</span>
                </div>
              </div>
              
              <div class="form-group">
                <label for="postTags">Tags</label>
                <input type="text" id="postTags" placeholder="Enter tags separated by commas...">
              </div>
              
              <div class="form-group">
                <label for="featuredImage">Featured Image</label>
                <input type="file" id="featuredImage">
              </div>
              
              <div style="margin-top: 15px;">
                <label style="display: flex; align-items: center;">
                  <input type="checkbox" id="noIndex" style="width: auto; margin-right: 8px;">
                  <span>No Index (hide from search engines)</span>
                </label>
              </div>
            </div>
            
            <div style="display: flex; justify-content: flex-end; gap: 10px;">
              <button type="button" id="previewPostBtn" class="secondary-button">Preview</button>
              <button type="submit" id="savePostBtn">Save Post</button>
            </div>
            
            <input type="hidden" id="postId">
          </form>
        </div>
        
        <!-- Categories Tab -->
        <div id="categoriesTab" class="blog-tab-content" style="display: none;">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
            <div>
              <h3 style="margin-top: 0; margin-bottom: 10px; font-size: 18px;">Categories</h3>
              <ul id="categoriesList" style="border: 1px solid var(--border-color); border-radius: 4px; padding: 10px; min-height: 200px; list-style: none;">
                <li style="padding: 8px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
                  <span>Technology</span>
                  <button class="btn-small btn-delete" style="padding: 3px 8px;">×</button>
                </li>
                <li style="padding: 8px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
                  <span>Programming</span>
                  <button class="btn-small btn-delete" style="padding: 3px 8px;">×</button>
                </li>
                <li style="padding: 8px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
                  <span>Design</span>
                  <button class="btn-small btn-delete" style="padding: 3px 8px;">×</button>
                </li>
              </ul>
            </div>
            
            <div>
              <h3 style="margin-top: 0; margin-bottom: 10px; font-size: 18px;">Add Category</h3>
              <form id="categoryForm">
                <div class="form-group">
                  <label for="categoryName">Name</label>
                  <input type="text" id="categoryName" placeholder="Category name...">
                </div>
                
                <div class="form-group">
                  <label for="categorySlug">Slug</label>
                  <input type="text" id="categorySlug" placeholder="category-slug">
                </div>
                
                <button type="submit">Add Category</button>
              </form>
            </div>
          </div>
        </div>
        
        <!-- Analytics Tab -->
        <div id="analyticsTab" class="blog-tab-content" style="display: none;">
          <div style="margin-top: 20px;">
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 25px;">
              <div style="border: 1px solid var(--border-color); border-radius: 4px; padding: 15px; text-align: center;">
                <div style="font-size: 24px; font-weight: bold; color: var(--primary-color); margin-bottom: 5px;">156</div>
                <div style="font-size: 14px; color: #6b7280;">Total Views This Month</div>
              </div>
              <div style="border: 1px solid var(--border-color); border-radius: 4px; padding: 15px; text-align: center;">
                <div style="font-size: 24px; font-weight: bold; color: var(--success-color); margin-bottom: 5px;">43</div>
                <div style="font-size: 14px; color: #6b7280;">New Subscribers</div>
              </div>
              <div style="border: 1px solid var(--border-color); border-radius: 4px; padding: 15px; text-align: center;">
                <div style="font-size: 24px; font-weight: bold; color: #3b82f6; margin-bottom: 5px;">3.2</div>
                <div style="font-size: 14px; color: #6b7280;">Avg. Time on Page (min)</div>
              </div>
            </div>
            
            <div style="border: 1px solid var(--border-color); border-radius: 4px; padding: 15px; margin-bottom: 25px;">
              <h3 style="margin-top: 0; margin-bottom: 15px; font-size: 18px;">Top Posts</h3>
              <table class="table">
                <thead>
                  <tr>
                    <th>Post</th>
                    <th>Views</th>
                    <th>Comments</th>
                    <th>Avg. Time</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>How to Build a React App with Firebase</td>
                    <td>42</td>
                    <td>7</td>
                    <td>4.5 min</td>
                  </tr>
                  <tr>
                    <td>Getting Started with TypeScript</td>
                    <td>38</td>
                    <td>5</td>
                    <td>3.2 min</td>
                  </tr>
                  <tr>
                    <td>Best Practices for Modern Web Development</td>
                    <td>27</td>
                    <td>3</td>
                    <td>2.8 min</td>
                  </tr>
                </tbody>
              </table>
            </div>
            
            <div style="border: 1px solid var(--border-color); border-radius: 4px; padding: 15px;">
              <h3 style="margin-top: 0; margin-bottom: 15px; font-size: 18px;">Traffic Sources</h3>
              <div style="min-height: 200px; background-color: #f1f5f9; display: flex; align-items: center; justify-content: center; border-radius: 4px;">
                <p style="color: #64748b;">Chart visualization will appear here</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div id="siteAdminTab" class="tab-content">
      <div class="card">
        <h2>Site Analytics</h2>
        <div style="text-align: center; padding: 30px 0;">
          <p style="color: #6b7280; margin-bottom: 20px;">Site analytics features coming soon. This will include:</p>
          <ul style="list-style: disc; text-align: left; max-width: 500px; margin: 0 auto; color: #6b7280;">
            <li style="margin-bottom: 10px;">Visitor count and traffic trends</li>
            <li style="margin-bottom: 10px;">Page view statistics</li>
            <li style="margin-bottom: 10px;">User journey and navigation flow analysis</li>
            <li style="margin-bottom: 10px;">Click tracking and heatmaps</li>
            <li style="margin-bottom: 10px;">Performance monitoring</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Add Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  
  <!-- Load secure configuration -->
  <script src="secure-config.js"></script>
  
  <script>
    // Get base path from URL or secure config
    function getBasePath() {
      // First try to get from secure config
      if (window.SECURE_CONFIG && window.SECURE_CONFIG.basePath) {
        return window.SECURE_CONFIG.basePath;
      }
      
      // Fallback to path detection
      if (window.location.hostname.includes('github.io')) {
        const pathMatch = window.location.pathname.match(/^\/([^/]+)/);
        if (pathMatch) {
          return pathMatch[0];
        }
      }
      return '/personalsite'; // Default fallback
    }
    
    // Try to load secure-config.js with different paths
    function loadSecureConfig() {
      const possiblePaths = [
        'secure-config.js',
        '/personalsite/secure-config.js',
        '../secure-config.js'
      ];
      
      let loaded = false;
      
      possiblePaths.forEach(path => {
        if (!loaded) {
          const script = document.createElement('script');
          script.src = path;
          script.onload = () => {
            console.log('Successfully loaded secure config from:', path);
            loaded = true;
            initializeApp();
          };
          script.onerror = () => {
            console.warn('Failed to load secure config from:', path);
          };
          document.head.appendChild(script);
        }
      });
      
      // Fallback initialization if no config loads
      setTimeout(() => {
        if (!loaded) {
          console.warn('Using fallback Firebase configuration');
          initializeApp();
        }
      }, 2000);
    }
    
    // Session management
    function checkSessionValidity() {
      const authSuccess = sessionStorage.getItem('auth_success');
      const authTimestamp = sessionStorage.getItem('auth_timestamp');
      
      if (!authSuccess || authSuccess !== 'true') {
        redirectToLogin('No active session found');
        return false;
      }
      
      if (authTimestamp) {
        const timestamp = new Date(authTimestamp);
        const now = new Date();
        const diffMs = now.getTime() - timestamp.getTime();
        const diffMin = Math.floor(diffMs / 60000);
        
        // Session timeout after 60 minutes of inactivity
        if (diffMin > 60) {
          redirectToLogin('Session expired. Please login again.');
          return false;
        }
        
        // Update timestamp for active session
        sessionStorage.setItem('auth_timestamp', now.toISOString());
      }
      
      return true;
    }
    
    // Redirect to login page
    function redirectToLogin(message) {
      console.log('Redirecting to login:', message);
      const authMessage = document.getElementById('authMessage');
      
      if (authMessage) {
        authMessage.textContent = message || 'Authentication required';
        authMessage.style.color = '#ef4444';
      }
      
      // Clear session storage
      sessionStorage.removeItem('auth_success');
      sessionStorage.removeItem('auth_timestamp');
      
      // Redirect after a delay
      setTimeout(() => {
        window.location.href = `${getBasePath()}/admin-login.html`;
      }, 2000);
    }
    
    // Initialize Firebase with configuration
    function initializeApp() {
      // Get Firebase config from secure-config.js or use fallback
      const firebaseConfig = window.SECURE_CONFIG && window.SECURE_CONFIG.firebase 
        ? window.SECURE_CONFIG.firebase 
        : {
            // Fallback config - will be replaced by GitHub Actions
            apiKey: "AIzaSyD4a8iaxHP9xPGV5tR5LwvzDVa5Y9o5wGQ",
            authDomain: "personalsite-19189.firebaseapp.com",
            projectId: "personalsite-19189",
            storageBucket: "personalsite-19189.appspot.com",
            messagingSenderId: "892517360036",
            appId: "1:892517360036:web:36dda234d9f3f79562e131"
          };
      
      // Initialize Firebase if not already initialized
      if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
      }
      
      // Check session validity
      if (!checkSessionValidity()) {
        return;
      }
      
      const auth = firebase.auth();
      const db = firebase.firestore();
      
      // Check if user is signed in with Firebase
      auth.onAuthStateChanged(function(user) {
        if (user) {
          console.log('User authenticated:', user.email);
          document.getElementById('authCheck').style.display = 'none';
          document.getElementById('adminDashboard').style.display = 'block';
          document.getElementById('userEmail').textContent = user.email;
          
          // Initialize admin dashboard
          initializeAdminDashboard(auth, db);
        } else {
          console.warn('No Firebase user found');
          redirectToLogin('Authentication required');
        }
      });
    }
    
    // Initialize admin dashboard functionality
    function initializeAdminDashboard(auth, db) {
      // DOM Elements
      const logoutButton = document.getElementById('logoutButton');
      const statusMessage = document.getElementById('statusMessage');
      const tabs = document.querySelectorAll('.tab');
      const tabContents = document.querySelectorAll('.tab-content');
      const bookForm = document.getElementById('bookForm');
      const booksTableBody = document.getElementById('booksTableBody');
      
      // Book collection reference
      const booksCollection = db.collection('books');
      
      // Get Google Books API configuration
      const googleBooksConfig = window.SECURE_CONFIG && window.SECURE_CONFIG.googleBooks ? window.SECURE_CONFIG.googleBooks : {
        apiKey: "" // No fallback key for Google Books API
      };
      
      // Load initial data
      loadBooks();
      updateStats();
      
      // Logout button click handler
      logoutButton.addEventListener('click', function() {
        auth.signOut().then(function() {
          // Clear session storage
          sessionStorage.removeItem('auth_success');
          sessionStorage.removeItem('auth_timestamp');
          
          // Redirect to login page
          window.location.href = `${getBasePath()}/admin-login.html`;
        });
      });
      
      // Tab switching
      tabs.forEach(function(tab) {
        tab.addEventListener('click', function() {
          // Remove active class from all tabs and contents
          tabs.forEach(t => t.classList.remove('active'));
          tabContents.forEach(c => c.classList.remove('active'));
          
          // Add active class to clicked tab and corresponding content
          this.classList.add('active');
          document.getElementById(this.dataset.tab + 'Tab').classList.add('active');
        });
      });
      
      // Book form submit handler
      bookForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const bookId = document.getElementById('bookId').value;
        const title = document.getElementById('title').value;
        const author = document.getElementById('author').value;
        const category = document.getElementById('category').value;
        const year = parseInt(document.getElementById('year').value);
        const description = document.getElementById('description').value;
        const coverImage = document.getElementById('coverImage').value;
        const isbn = document.getElementById('bookIsbn').value;
        const status = document.getElementById('status').value;
        const userRating = document.getElementById('userRating').value ? parseInt(document.getElementById('userRating').value) : null;
        const notes = document.getElementById('notes').value;
        
        const bookData = {
          title,
          authors: author.split(',').map(a => a.trim()),
          categories: category ? [category] : [],
          publishedDate: year ? year.toString() : '',
          description: description || '',
          imageLinks: coverImage ? {
            thumbnail: coverImage,
            smallThumbnail: coverImage
          } : undefined,
          isbn: isbn || '',
          status: status || 'toRead',
          userRating,
          notes: notes || '',
          updatedAt: new Date()
        };
        
        if (bookId) {
          // Update existing book
          booksCollection.doc(bookId).update(bookData)
            .then(function() {
              showMessage('Book updated successfully!', 'success');
              resetBookForm();
              loadBooks();
              updateStats();
              
              // Switch to book list tab
              document.querySelector('[data-tab="bookList"]').click();
            })
            .catch(function(error) {
              showMessage('Error updating book: ' + error.message, 'error');
            });
        } else {
          // Add created date for new books
          bookData.createdAt = new Date();
          
          // Add new book
          booksCollection.add(bookData)
            .then(function() {
              showMessage('Book added successfully!', 'success');
              resetBookForm();
              loadBooks();
              updateStats();
              
              // Switch to book list tab
              document.querySelector('[data-tab="bookList"]').click();
            })
            .catch(function(error) {
              showMessage('Error adding book: ' + error.message, 'error');
            });
        }
      });
      
      // Search tab handling
      const searchByIsbnBtn = document.getElementById('searchByIsbnBtn');
      const searchByTitleBtn = document.getElementById('searchByTitleBtn');
      const isbnSearchContainer = document.getElementById('isbnSearchContainer');
      const titleSearchContainer = document.getElementById('titleSearchContainer');
      
      searchByIsbnBtn.addEventListener('click', function() {
        searchByIsbnBtn.style.backgroundColor = 'var(--primary-color)';
        searchByIsbnBtn.style.color = 'white';
        searchByTitleBtn.style.backgroundColor = '#e5e7eb';
        searchByTitleBtn.style.color = 'var(--text-color)';
        isbnSearchContainer.style.display = 'block';
        titleSearchContainer.style.display = 'none';
        document.getElementById('searchResults').style.display = 'none';
      });
      
      searchByTitleBtn.addEventListener('click', function() {
        searchByTitleBtn.style.backgroundColor = 'var(--primary-color)';
        searchByTitleBtn.style.color = 'white';
        searchByIsbnBtn.style.backgroundColor = '#e5e7eb';
        searchByIsbnBtn.style.color = 'var(--text-color)';
        titleSearchContainer.style.display = 'block';
        isbnSearchContainer.style.display = 'none';
        document.getElementById('searchResults').style.display = 'none';
      });
      
      // ISBN Search
      const isbnSearchBtn = document.getElementById('isbnSearchBtn');
      const isbnSearchInput = document.getElementById('isbnSearch');
      
      isbnSearchBtn.addEventListener('click', function() {
        const isbn = isbnSearchInput.value.trim();
        if (!isbn) {
          showMessage('Please enter an ISBN', 'error');
          return;
        }
        
        isbnSearchBtn.disabled = true;
        isbnSearchBtn.textContent = 'Searching...';
        
        // Get Google Books API key from secure config if available
        const apiKey = googleBooksConfig && googleBooksConfig.apiKey ? 
          `&key=${googleBooksConfig.apiKey}` : '';
        
        // Fetch book data from Google Books API
        fetch(`https://www.googleapis.com/books/v1/volumes?q=isbn:${isbn}${apiKey}`)
          .then(response => {
            if (!response.ok) {
              throw new Error(`Google Books API error: ${response.statusText}`);
            }
            return response.json();
          })
          .then(data => {
            isbnSearchBtn.disabled = false;
            isbnSearchBtn.textContent = 'Lookup';
            
            if (!data.items || data.items.length === 0) {
              showMessage('No books found with this ISBN. Please check and try again.', 'error');
              return;
            }
            
            // Get the first result
            const book = data.items[0].volumeInfo;
            populateBookPreview(book, isbn);
            populateBookForm(book, isbn);
          })
          .catch(error => {
            console.error('Error searching by ISBN:', error);
            showMessage('Error looking up book. Please try again.', 'error');
            isbnSearchBtn.disabled = false;
            isbnSearchBtn.textContent = 'Lookup';
          });
      });
      
      // Title/Author Search
      const titleSearchBtn = document.getElementById('titleSearchBtn');
      const titleSearchInput = document.getElementById('titleSearch');
      const searchResults = document.getElementById('searchResults');
      const searchResultsList = document.getElementById('searchResultsList');
      
      titleSearchBtn.addEventListener('click', function() {
        const query = titleSearchInput.value.trim();
        if (!query) {
          showMessage('Please enter a search term', 'error');
          return;
        }
        
        titleSearchBtn.disabled = true;
        titleSearchBtn.textContent = 'Searching...';
        
        // Get Google Books API key from secure config if available
        const apiKey = googleBooksConfig && googleBooksConfig.apiKey ? 
          `&key=${googleBooksConfig.apiKey}` : '';
        
        // Fetch book data from Google Books API
        fetch(`https://www.googleapis.com/books/v1/volumes?q=${encodeURIComponent(query)}&maxResults=10${apiKey}`)
          .then(response => {
            if (!response.ok) {
              throw new Error(`Google Books API error: ${response.statusText}`);
            }
            return response.json();
          })
          .then(data => {
            titleSearchBtn.disabled = false;
            titleSearchBtn.textContent = 'Search';
            
            if (!data.items || data.items.length === 0) {
              showMessage('No books found. Please try a different search term.', 'error');
              return;
            }
            
            // Display search results
            displaySearchResults(data.items);
          })
          .catch(error => {
            console.error('Error searching books:', error);
            showMessage('Error searching books. Please try again.', 'error');
            titleSearchBtn.disabled = false;
            titleSearchBtn.textContent = 'Search';
          });
      });
      
      // Blog Management
      setupBlogManagement(db);
      
      // Function to load books
      function loadBooks() {
        booksCollection.orderBy('title').get()
          .then(function(querySnapshot) {
            if (querySnapshot.empty) {
              booksTableBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">No books found. Add some books to see them here.</td></tr>';
              return;
            }
            
            let booksHTML = '';
            querySnapshot.forEach(function(doc) {
              const book = doc.data();
              
              // Format the status display
              let statusDisplay = '';
              if (book.status === 'read') statusDisplay = 'Read';
              else if (book.status === 'reading') statusDisplay = 'Reading';
              else if (book.status === 'toRead') statusDisplay = 'To Read';
              else statusDisplay = book.status || '-';
              
              // Format the rating display with stars
              let ratingDisplay = '';
              if (book.userRating) {
                const stars = '★'.repeat(book.userRating) + '☆'.repeat(5 - book.userRating);
                ratingDisplay = `${stars} (${book.userRating}/5)`;
              } else {
                ratingDisplay = '-';
              }
              
              // Handle author display (support both string and array formats)
              const authorDisplay = Array.isArray(book.authors) 
                ? book.authors.join(', ')
                : book.author || 'Unknown Author';
                
              // Handle category display (support both string and array formats)
              const categoryDisplay = Array.isArray(book.categories) && book.categories.length > 0
                ? book.categories[0]
                : book.category || '-';
              
              // Handle year display (support both number and string formats)
              const yearDisplay = book.year 
                ? book.year 
                : (book.publishedDate ? book.publishedDate.substring(0, 4) : '-');
              
              booksHTML += `
                <tr>
                  <td>${book.title}</td>
                  <td>${authorDisplay}</td>
                  <td>${categoryDisplay}</td>
                  <td>${yearDisplay}</td>
                  <td>${statusDisplay}</td>
                  <td>${ratingDisplay}</td>
                  <td>${book.isbn || '-'}</td>
                  <td class="action-buttons">
                    <button class="btn-small btn-edit" data-id="${doc.id}">Edit</button>
                    <button class="btn-small btn-delete" data-id="${doc.id}">Delete</button>
                  </td>
                </tr>
              `;
            });
            
            booksTableBody.innerHTML = booksHTML;
            
            // Add event listeners to edit and delete buttons
            document.querySelectorAll('.btn-edit').forEach(function(button) {
              button.addEventListener('click', function() {
                editBook(this.dataset.id);
              });
            });
            
            document.querySelectorAll('.btn-delete').forEach(function(button) {
              button.addEventListener('click', function() {
                deleteBook(this.dataset.id);
              });
            });
          })
          .catch(function(error) {
            showMessage('Error loading books: ' + error.message, 'error');
          });
      }
      
      // Function to update statistics
      function updateStats() {
        booksCollection.get()
          .then(function(querySnapshot) {
            const books = [];
            const categoriesSet = new Set();
            let fiction = 0;
            let nonFiction = 0;
            
            querySnapshot.forEach(function(doc) {
              const book = doc.data();
              books.push(book);
              
              // Handle categories properly - could be array or string
              if (Array.isArray(book.categories) && book.categories.length > 0) {
                // Add each category to the set
                book.categories.forEach(cat => {
                  if (cat) categoriesSet.add(cat.toLowerCase());
                });
                
                // Count fiction vs non-fiction
                const isFiction = book.categories.some(cat => 
                  cat && cat.toLowerCase().includes('fiction'));
                if (isFiction) {
                  fiction++;
                } else {
                  nonFiction++;
                }
              } else if (book.category) {
                // Legacy format with single category
                categoriesSet.add(book.category.toLowerCase());
                
                // Count fiction vs non-fiction
                if (book.category.toLowerCase().includes('fiction')) {
                  fiction++;
                } else {
                  nonFiction++;
                }
              }
            });
            
            console.log(`Stats: Found ${books.length} books, ${categoriesSet.size} categories`);
            console.log(`Fiction: ${fiction}, Non-Fiction: ${nonFiction}`);
            
            document.getElementById('totalBooks').textContent = books.length;
            document.getElementById('totalCategories').textContent = categoriesSet.size;
            document.getElementById('fictionBooks').textContent = fiction;
            document.getElementById('nonFictionBooks').textContent = nonFiction;
          })
          .catch(function(error) {
            console.error('Error updating stats:', error);
          });
      }
      
      // Function to edit a book
      function editBook(id) {
        booksCollection.doc(id).get()
          .then(function(doc) {
            if (doc.exists) {
              const book = doc.data();
              
              // Fill form with book data
              document.getElementById('bookId').value = id;
              document.getElementById('title').value = book.title;
              
              // Handle authors array or string
              if (Array.isArray(book.authors)) {
                document.getElementById('author').value = book.authors.join(', ');
              } else if (book.author) {
                document.getElementById('author').value = book.author;
              } else {
                document.getElementById('author').value = '';
              }
              
              // Handle categories array or single category
              if (Array.isArray(book.categories) && book.categories.length > 0) {
                document.getElementById('category').value = book.categories[0];
              } else if (book.category) {
                document.getElementById('category').value = book.category;
              } else {
                document.getElementById('category').value = '';
              }
              
              // Handle year or publishedDate
              if (book.year) {
                document.getElementById('year').value = book.year;
              } else if (book.publishedDate) {
                document.getElementById('year').value = book.publishedDate.substring(0, 4);
              } else {
                document.getElementById('year').value = '';
              }
              
              document.getElementById('description').value = book.description || '';
              
              // Handle coverImage or imageLinks
              if (book.imageLinks && book.imageLinks.thumbnail) {
                document.getElementById('coverImage').value = book.imageLinks.thumbnail;
              } else if (book.coverImage) {
                document.getElementById('coverImage').value = book.coverImage;
              } else {
                document.getElementById('coverImage').value = '';
              }
              
              document.getElementById('bookIsbn').value = book.isbn || '';
              
              // Set status
              const statusSelect = document.getElementById('status');
              if (book.status) {
                // Find the option with the matching value
                for (let i = 0; i < statusSelect.options.length; i++) {
                  if (statusSelect.options[i].value === book.status) {
                    statusSelect.selectedIndex = i;
                    break;
                  }
                }
              }
              
              // Set rating
              const ratingSelect = document.getElementById('userRating');
              if (book.userRating) {
                // Find the option with the matching value
                for (let i = 0; i < ratingSelect.options.length; i++) {
                  if (ratingSelect.options[i].value === book.userRating.toString()) {
                    ratingSelect.selectedIndex = i;
                    break;
                  }
                }
              } else {
                ratingSelect.selectedIndex = 0;
              }
              
              // Set notes
              document.getElementById('notes').value = book.notes || '';
              
              // Update book preview
              const coverImage = book.imageLinks?.thumbnail || book.coverImage;
              if (coverImage || book.description) {
                const previewData = {
                  title: book.title,
                  authors: Array.isArray(book.authors) ? book.authors : [book.author || 'Unknown Author'],
                  publisher: '',
                  publishedDate: book.publishedDate || (book.year ? book.year.toString() : ''),
                  description: book.description || '',
                  imageLinks: coverImage ? { thumbnail: coverImage } : undefined
                };
                populateBookPreview(previewData, book.isbn || '');
              } else {
                document.getElementById('bookPreview').style.display = 'none';
              }
              
              // Switch to add book tab
              document.querySelector('[data-tab="addBook"]').click();
              
              // Change button text
              document.getElementById('saveBookButton').textContent = 'Update Book';
            } else {
              showMessage('Book not found', 'error');
            }
          })
          .catch(function(error) {
            showMessage('Error loading book: ' + error.message, 'error');
          });
      }
      
      // Function to delete a book
      function deleteBook(id) {
        if (confirm('Are you sure you want to delete this book?')) {
          booksCollection.doc(id).delete()
            .then(function() {
              showMessage('Book deleted successfully!', 'success');
              loadBooks();
              updateStats();
            })
            .catch(function(error) {
              showMessage('Error deleting book: ' + error.message, 'error');
            });
        }
      }
      
      // Function to reset book form
      function resetBookForm() {
        document.getElementById('bookId').value = '';
        document.getElementById('bookIsbn').value = '';
        bookForm.reset();
        
        // Reset select elements to defaults
        document.getElementById('status').selectedIndex = 2; // toRead by default
        document.getElementById('userRating').selectedIndex = 0; // No rating by default
        
        document.getElementById('saveBookButton').textContent = 'Save Book';
        document.getElementById('bookPreview').style.display = 'none';
        document.getElementById('searchResults').style.display = 'none';
      }
      
      // Display search results
      function displaySearchResults(books) {
        searchResultsList.innerHTML = '';
        
        books.forEach(item => {
          const book = item.volumeInfo;
          const industryIdentifiers = book.industryIdentifiers || [];
          const isbn = industryIdentifiers.find(id => id.type === 'ISBN_13')?.identifier || 
                      industryIdentifiers.find(id => id.type === 'ISBN_10')?.identifier || '';
          
          const resultItem = document.createElement('div');
          resultItem.className = 'result-item';
          resultItem.style.padding = '10px';
          resultItem.style.borderBottom = '1px solid var(--border-color)';
          resultItem.style.cursor = 'pointer';
          resultItem.style.display = 'flex';
          resultItem.style.alignItems = 'start';
          
          // Book cover
          const coverContainer = document.createElement('div');
          coverContainer.style.width = '50px';
          coverContainer.style.height = '75px';
          coverContainer.style.marginRight = '10px';
          coverContainer.style.backgroundColor = '#ddd';
          coverContainer.style.display = 'flex';
          coverContainer.style.alignItems = 'center';
          coverContainer.style.justifyContent = 'center';
          
          if (book.imageLinks && book.imageLinks.thumbnail) {
            const cover = document.createElement('img');
            cover.src = book.imageLinks.thumbnail;
            cover.style.width = '100%';
            cover.style.height = '100%';
            cover.style.objectFit = 'cover';
            coverContainer.appendChild(cover);
          } else {
            coverContainer.textContent = 'No Cover';
            coverContainer.style.fontSize = '8px';
            coverContainer.style.textAlign = 'center';
          }
          
          // Book info
          const infoContainer = document.createElement('div');
          infoContainer.style.flex = '1';
          
          const title = document.createElement('div');
          title.textContent = book.title;
          title.style.fontWeight = 'bold';
          title.style.fontSize = '14px';
          
          const author = document.createElement('div');
          author.textContent = book.authors ? book.authors.join(', ') : 'Unknown Author';
          author.style.fontSize = '12px';
          
          const year = document.createElement('div');
          year.textContent = book.publishedDate ? book.publishedDate.substring(0, 4) : '';
          year.style.fontSize = '10px';
          year.style.color = '#666';
          
          infoContainer.appendChild(title);
          infoContainer.appendChild(author);
          infoContainer.appendChild(year);
          
          resultItem.appendChild(coverContainer);
          resultItem.appendChild(infoContainer);
          
          // Add click handler
          resultItem.addEventListener('click', function() {
            populateBookPreview(book, isbn);
            populateBookForm(book, isbn);
            searchResults.style.display = 'none';
          });
          
          searchResultsList.appendChild(resultItem);
        });
        
        searchResults.style.display = 'block';
      }
      
      // Populate book preview
      function populateBookPreview(book, isbn) {
        const bookPreview = document.getElementById('bookPreview');
        const bookPreviewTitle = document.getElementById('bookPreviewTitle');
        const bookPreviewAuthor = document.getElementById('bookPreviewAuthor');
        const bookPreviewPublisher = document.getElementById('bookPreviewPublisher');
        const bookPreviewIsbn = document.getElementById('bookPreviewIsbn');
        const bookPreviewDescription = document.getElementById('bookPreviewDescription');
        const bookPreviewCover = document.getElementById('bookPreviewCover');
        
        bookPreviewTitle.textContent = book.title || 'Unknown Title';
        bookPreviewAuthor.textContent = book.authors ? book.authors.join(', ') : 'Unknown Author';
        bookPreviewPublisher.textContent = `${book.publisher || 'Unknown Publisher'}${book.publishedDate ? ', ' + book.publishedDate : ''}`;
        bookPreviewIsbn.textContent = `ISBN: ${isbn || 'Unknown'}`;
        
        // Set description
        bookPreviewDescription.textContent = book.description || 'No description available';
        
        // If we have Google ratings, add them to the description
        if (book.averageRating) {
          const googleRating = '★'.repeat(Math.round(book.averageRating)) + 
                               '☆'.repeat(5 - Math.round(book.averageRating));
          const ratingsInfo = `\n\nGoogle Rating: ${googleRating} (${book.averageRating}/5 from ${book.ratingsCount} ratings)`;
          bookPreviewDescription.textContent += ratingsInfo;
        }
        
        // Handle cover image
        if (book.imageLinks && book.imageLinks.thumbnail) {
          bookPreviewCover.innerHTML = `<img src="${book.imageLinks.thumbnail}" alt="Book cover" style="width: 100%; height: 100%; object-fit: cover;">`;
        } else {
          bookPreviewCover.innerHTML = 'No Cover';
        }
        
        bookPreview.style.display = 'block';
      }
      
      // Populate book form
      function populateBookForm(book, isbn) {
        document.getElementById('title').value = book.title || '';
        document.getElementById('author').value = book.authors ? book.authors.join(', ') : '';
        document.getElementById('category').value = book.categories ? book.categories[0] : '';
        document.getElementById('year').value = book.publishedDate ? book.publishedDate.substring(0, 4) : '';
        document.getElementById('description').value = book.description || '';
        
        // Set the cover image URL - store in the right format for BookSpine component
        const coverImageUrl = book.imageLinks && book.imageLinks.thumbnail ? book.imageLinks.thumbnail : '';
        document.getElementById('coverImage').value = coverImageUrl;
        document.getElementById('bookIsbn').value = isbn || '';
        
        // Set default status to "Want to Read" for new books
        const statusSelect = document.getElementById('status');
        statusSelect.value = 'toRead';
        
        // Reset notes and rating for new books
        document.getElementById('notes').value = '';
        document.getElementById('userRating').selectedIndex = 0;
      }
      
      // Show message function
      function showMessage(message, type) {
        statusMessage.textContent = message;
        statusMessage.className = '';
        statusMessage.classList.add('alert', `alert-${type}`);
        statusMessage.style.display = 'block';
        
        // Hide message after 3 seconds
        setTimeout(function() {
          statusMessage.style.display = 'none';
        }, 3000);
      }
      
      // Add event listeners for enter key in search inputs
      isbnSearchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          isbnSearchBtn.click();
        }
      });
      
      titleSearchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          titleSearchBtn.click();
        }
      });
    }
    
    // Setup Blog Management
    function setupBlogManagement(db) {
      // Blog tab navigation
      const blogTabs = document.querySelectorAll('[data-blog-tab]');
      
      if (blogTabs.length > 0) {
        blogTabs.forEach(tab => {
          tab.addEventListener('click', function() {
            // Remove active class from all tabs
            blogTabs.forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            
            // Hide all blog tab content
            document.querySelectorAll('.blog-tab-content').forEach(content => {
              content.style.display = 'none';
            });
            
            // Show selected tab content
            const tabId = this.getAttribute('data-blog-tab') + 'Tab';
            document.getElementById(tabId).style.display = 'block';
          });
        });
      }
      
      // New Post button
      const newPostBtn = document.getElementById('newPostBtn');
      if (newPostBtn) {
        newPostBtn.addEventListener('click', function() {
          document.querySelector('[data-blog-tab="newPost"]').click();
        });
      }
      
      // Post status change handler
      const postStatus = document.getElementById('postStatus');
      const schedulingOptions = document.getElementById('schedulingOptions');
      if (postStatus && schedulingOptions) {
        postStatus.addEventListener('change', function() {
          if (this.value === 'scheduled') {
            schedulingOptions.style.display = 'block';
          } else {
            schedulingOptions.style.display = 'none';
          }
        });
      }
      
      // Meta description character counter
      const metaDescription = document.getElementById('metaDescription');
      const metaDescLength = document.getElementById('metaDescLength');
      const metaDescStatus = document.getElementById('metaDescStatus');
      if (metaDescription && metaDescLength && metaDescStatus) {
        metaDescription.addEventListener('input', function() {
          const length = this.value.length;
          metaDescLength.textContent = length;
          
          if (length === 0) {
            metaDescStatus.textContent = 'Too short';
            metaDescStatus.style.color = '#ef4444';
          } else if (length < 50) {
            metaDescStatus.textContent = 'Too short';
            metaDescStatus.style.color = '#ef4444';
          } else if (length <= 160) {
            metaDescStatus.textContent = 'Good length';
            metaDescStatus.style.color = '#22c55e';
          } else {
            metaDescStatus.textContent = 'Too long';
            metaDescStatus.style.color = '#ef4444';
          }
        });
      }
      
      // Auto-generate slug from title
      const postTitle = document.getElementById('postTitle');
      const postSlug = document.getElementById('postSlug');
      if (postTitle && postSlug) {
        postTitle.addEventListener('blur', function() {
          if (!postSlug.value) {
            postSlug.value = this.value
              .toLowerCase()
              .replace(/[^\w\s]/gi, '')
              .replace(/\s+/g, '-');
          }
        });
      }
      
      // Editor toolbar functionality
      const editorToolbar = document.getElementById('editorToolbar');
      const postContent = document.getElementById('postContent');
      if (editorToolbar && postContent) {
        editorToolbar.querySelectorAll('button').forEach(button => {
          button.addEventListener('click', function(e) {
            e.preventDefault(); // Prevent form submission
            
            const format = this.getAttribute('data-format');
            const textarea = postContent;
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const selectedText = textarea.value.substring(start, end);
            let replacement = '';
            
            switch (format) {
              case 'bold':
                replacement = `**${selectedText}**`;
                break;
              case 'italic':
                replacement = `*${selectedText}*`;
                break;
              case 'heading':
                replacement = `\n## ${selectedText}\n`;
                break;
              case 'link':
                replacement = `[${selectedText}](url)`;
                break;
              case 'image':
                replacement = `![Alt text](image-url)`;
                break;
              case 'code':
                replacement = `\`\`\`\n${selectedText}\n\`\`\``;
                break;
              case 'quote':
                replacement = `\n> ${selectedText}\n`;
                break;
              case 'list':
                replacement = `\n- Item 1\n- Item 2\n- Item 3\n`;
                break;
            }
            
            textarea.value = textarea.value.substring(0, start) + replacement + textarea.value.substring(end);
            textarea.focus();
            textarea.selectionStart = start + replacement.length;
            textarea.selectionEnd = start + replacement.length;
          });
        });
      }
      
      // Load blog posts
      loadBlogPosts();
      
      // Post form submission
      const postForm = document.getElementById('postForm');
      if (postForm) {
        postForm.addEventListener('submit', function(e) {
          e.preventDefault();
          
          // Get form values
          const postId = document.getElementById('postId')?.value;
          const title = document.getElementById('postTitle').value;
          const content = document.getElementById('postContent').value;
          const category = document.getElementById('postCategory').value;
          const status = document.getElementById('postStatus').value;
          const slug = document.getElementById('postSlug').value;
          const metaDescription = document.getElementById('metaDescription').value;
          const tags = document.getElementById('postTags').value.split(',').map(tag => tag.trim()).filter(Boolean);
          const noIndex = document.getElementById('noIndex').checked;
          
          // Create post data object
          const postData = {
            title,
            content,
            category,
            status,
            slug,
            metaDescription,
            tags,
            noIndex,
            updatedAt: new Date().toISOString()
          };
          
          // Add publish date for scheduled posts
          if (status === 'scheduled') {
            const publishDate = document.getElementById('publishDate').value;
            postData.publishDate = publishDate ? new Date(publishDate).toISOString() : null;
          }
          
          const blogPostsCollection = db.collection('blog-posts');
          
          if (postId) {
            // Update existing post
            blogPostsCollection.doc(postId).update(postData)
              .then(() => {
                showMessage('Blog post updated successfully!', 'success');
                resetPostForm();
                loadBlogPosts();
                
                // Switch to post list tab
                document.querySelector('[data-blog-tab="postList"]').click();
              })
              .catch(error => {
                showMessage('Error updating blog post: ' + error.message, 'error');
              });
          } else {
            // Add created date for new posts
            postData.createdAt = new Date().toISOString();
            
            // Create new post
            blogPostsCollection.add(postData)
              .then(() => {
                showMessage('Blog post created successfully!', 'success');
                resetPostForm();
                loadBlogPosts();
                
                // Switch to post list tab
                document.querySelector('[data-blog-tab="postList"]').click();
              })
              .catch(error => {
                showMessage('Error creating blog post: ' + error.message, 'error');
              });
          }
        });
      }
      
      // Function to reset post form
      function resetPostForm() {
        if (document.getElementById('postId')) {
          document.getElementById('postId').value = '';
        }
        postForm.reset();
        document.getElementById('schedulingOptions').style.display = 'none';
        document.getElementById('savePostBtn').textContent = 'Save Post';
      }
      
      // Function to load blog posts
      function loadBlogPosts() {
        const postsTableBody = document.getElementById('postsTableBody');
        const blogPostsCollection = db.collection('blog-posts');
        
        // Show loading state
        postsTableBody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px;">Loading posts...</td></tr>';
        
        blogPostsCollection.orderBy('createdAt', 'desc').get()
          .then(snapshot => {
            if (snapshot.empty) {
              postsTableBody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px;">No posts found. Create one to get started!</td></tr>';
              return;
            }
            
            let postsHTML = '';
            snapshot.forEach(doc => {
              const post = doc.data();
              
              try {
                // Handle dates that could be Firestore timestamps or ISO strings
                const postDate = post.createdAt ? 
                  (typeof post.createdAt === 'object' && post.createdAt.toDate ? 
                    post.createdAt.toDate().toLocaleDateString() : 
                    new Date(post.createdAt).toLocaleDateString()
                  ) : 'Unknown';
                
                // Status display
                let statusDisplay = '';
                if (post.status === 'published') {
                  statusDisplay = '<span style="padding: 3px 8px; background-color: #dcfce7; color: #22c55e; border-radius: 4px; font-size: 12px;">Published</span>';
                } else if (post.status === 'draft') {
                  statusDisplay = '<span style="padding: 3px 8px; background-color: #f1f5f9; color: #64748b; border-radius: 4px; font-size: 12px;">Draft</span>';
                } else if (post.status === 'scheduled') {
                  statusDisplay = '<span style="padding: 3px 8px; background-color: #dbeafe; color: #3b82f6; border-radius: 4px; font-size: 12px;">Scheduled</span>';
                } else {
                  statusDisplay = '<span style="padding: 3px 8px; background-color: #f1f5f9; color: #64748b; border-radius: 4px; font-size: 12px;">Draft</span>';
                }
                
                postsHTML += `
                  <tr>
                    <td>${post.title || 'Untitled'}</td>
                    <td>${statusDisplay}</td>
                    <td>${post.category || '-'}</td>
                    <td>${postDate}</td>
                    <td>
                      <div style="display: flex; gap: 5px;">
                        <button class="btn-small btn-edit edit-post-btn" data-id="${doc.id}">Edit</button>
                        <button class="btn-small btn-delete delete-post-btn" data-id="${doc.id}">Delete</button>
                      </div>
                    </td>
                  </tr>
                `;
              } catch (error) {
                console.error('Error processing post:', error, post);
                // Skip this post if there's an error
              }
            });
            
            postsTableBody.innerHTML = postsHTML;
            
            // Add event listeners to edit and delete buttons
            document.querySelectorAll('.edit-post-btn').forEach(btn => {
              btn.addEventListener('click', function() {
                editPost(this.getAttribute('data-id'));
              });
            });
            
            document.querySelectorAll('.delete-post-btn').forEach(btn => {
              btn.addEventListener('click', function() {
                deletePost(this.getAttribute('data-id'));
              });
            });
          })
          .catch(error => {
            console.error('Error loading blog posts:', error);
            postsTableBody.innerHTML = `<tr><td colspan="5" style="text-align: center; padding: 20px; color: #ef4444;">Error loading posts: ${error.message}</td></tr>`;
          });
      }
      
      // Function to edit a post
      function editPost(postId) {
        const blogPostsCollection = db.collection('blog-posts');
        
        blogPostsCollection.doc(postId).get()
          .then(doc => {
            if (doc.exists) {
              const post = doc.data();
              
              // Create hidden input for post ID if it doesn't exist
              if (!document.getElementById('postId')) {
                const postIdInput = document.createElement('input');
                postIdInput.type = 'hidden';
                postIdInput.id = 'postId';
                document.getElementById('postForm').appendChild(postIdInput);
              }
              
              // Populate form with post data
              document.getElementById('postId').value = postId;
              document.getElementById('postTitle').value = post.title || '';
              document.getElementById('postContent').value = post.content || '';
              document.getElementById('postCategory').value = post.category || '';
              document.getElementById('postStatus').value = post.status || 'draft';
              document.getElementById('postSlug').value = post.slug || '';
              document.getElementById('metaDescription').value = post.metaDescription || '';
              document.getElementById('postTags').value = post.tags ? post.tags.join(', ') : '';
              document.getElementById('noIndex').checked = post.noIndex || false;
              
              // Handle scheduled posts
              if (post.status === 'scheduled' && post.publishDate) {
                document.getElementById('schedulingOptions').style.display = 'block';
                
                // Format date for datetime-local input
                try {
                  const publishDate = new Date(post.publishDate);
                  const localDate = new Date(publishDate.getTime() - publishDate.getTimezoneOffset() * 60000);
                  document.getElementById('publishDate').value = localDate.toISOString().slice(0, 16);
                } catch (e) {
                  console.error('Error formatting publish date:', e);
                }
              } else {
                document.getElementById('schedulingOptions').style.display = 'none';
              }
              
              // Update button text
              document.getElementById('savePostBtn').textContent = 'Update Post';
              
              // Switch to new post tab
              document.querySelector('[data-blog-tab="newPost"]').click();
            } else {
              showMessage('Post not found', 'error');
            }
          })
          .catch(error => {
            showMessage('Error loading post: ' + error.message, 'error');
          });
      }
      
      // Function to delete a post
      function deletePost(postId) {
        if (confirm('Are you sure you want to delete this post?')) {
          const blogPostsCollection = db.collection('blog-posts');
          
          blogPostsCollection.doc(postId).delete()
            .then(() => {
              showMessage('Post deleted successfully!', 'success');
              loadBlogPosts();
            })
            .catch(error => {
              showMessage('Error deleting post: ' + error.message, 'error');
            });
        }
      }
      
      // Function to show status messages
      function showMessage(message, type) {
        const statusMessage = document.getElementById('statusMessage');
        statusMessage.textContent = message;
        statusMessage.className = '';
        statusMessage.classList.add('alert', `alert-${type}`);
        statusMessage.style.display = 'block';
        
        // Hide message after 3 seconds
        setTimeout(function() {
          statusMessage.style.display = 'none';
        }, 3000);
      }
    }
    
    // Start the initialization process
    loadSecureConfig();
  </script>
</body>
</html>