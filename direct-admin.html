<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard</title>
  <style>
    :root {
      --primary-color: #3b82f6;
      --primary-hover: #2563eb;
      --text-color: #333;
      --bg-color: #f5f7fa;
      --card-bg: #fff;
      --border-color: #e5e7eb;
      --success-color: #22c55e;
      --error-color: #ef4444;
      --warning-color: #f59e0b;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      line-height: 1.6;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 0;
      border-bottom: 1px solid var(--border-color);
      margin-bottom: 30px;
    }
    
    .header h1 {
      color: var(--primary-color);
      font-size: 24px;
    }
    
    .user-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .login-container {
      max-width: 400px;
      margin: 80px auto;
      padding: 30px;
      background-color: var(--card-bg);
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .login-container h2 {
      margin-bottom: 20px;
      color: var(--primary-color);
      text-align: center;
    }
    
    .login-form {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    
    .form-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    
    label {
      font-weight: 500;
      font-size: 14px;
    }
    
    input {
      padding: 10px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      font-size: 16px;
    }
    
    button {
      background-color: var(--primary-color);
      color: white;
      border: none;
      padding: 12px;
      border-radius: 4px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    button:hover {
      background-color: var(--primary-hover);
    }
    
    button:disabled {
      background-color: #93c5fd;
      cursor: not-allowed;
    }
    
    .secondary-button {
      background-color: #6b7280;
    }
    
    .secondary-button:hover {
      background-color: #4b5563;
    }
    
    .card {
      background-color: var(--card-bg);
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .admin-dashboard {
      display: none;
    }
    
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      background-color: var(--card-bg);
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      padding: 20px;
      text-align: center;
    }
    
    .stat-card h3 {
      font-size: 14px;
      color: #6b7280;
      margin-bottom: 10px;
    }
    
    .stat-card .value {
      font-size: 24px;
      font-weight: 700;
      color: var(--primary-color);
    }
    
    .table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .table th, .table td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid var(--border-color);
    }
    
    .table th {
      background-color: #f8fafc;
      font-weight: 600;
      color: #6b7280;
    }
    
    .alert {
      padding: 12px 15px;
      border-radius: 4px;
      margin-bottom: 20px;
    }
    
    .alert-error {
      background-color: #fee2e2;
      color: var(--error-color);
      border-left: 4px solid var(--error-color);
    }
    
    .alert-success {
      background-color: #dcfce7;
      color: var(--success-color);
      border-left: 4px solid var(--success-color);
    }
    
    .hidden {
      display: none;
    }
    
    .book-form {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    
    .action-buttons {
      display: flex;
      gap: 10px;
    }
    
    .btn-small {
      padding: 6px 12px;
      font-size: 14px;
    }
    
    .btn-edit {
      background-color: #f59e0b;
    }
    
    .btn-edit:hover {
      background-color: #d97706;
    }
    
    .btn-delete {
      background-color: #ef4444;
    }
    
    .btn-delete:hover {
      background-color: #dc2626;
    }
    
    .tabs {
      display: flex;
      gap: 5px;
      margin-bottom: 20px;
      border-bottom: 1px solid var(--border-color);
    }
    
    .tab {
      padding: 10px 15px;
      cursor: pointer;
      border-bottom: 2px solid transparent;
    }
    
    .tab.active {
      border-bottom: 2px solid var(--primary-color);
      color: var(--primary-color);
      font-weight: 500;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    #statusMessage {
      padding: 12px 15px;
      border-radius: 4px;
      margin: 20px 0;
      display: none;
    }
  </style>
</head>
<body>
  <!-- Login Page -->
  <div id="loginPage" class="container">
    <div class="login-container">
      <h2>Admin Login</h2>
      
      <div id="loginError" class="alert alert-error hidden">
        <strong>Error:</strong> <span id="errorText"></span>
      </div>
      
      <form id="loginForm" class="login-form">
        <div class="form-group">
          <label for="email">Email</label>
          <input type="email" id="email" required placeholder="your@email.com" autocomplete="username email">
        </div>
        
        <div class="form-group">
          <label for="password">Password</label>
          <input type="password" id="password" required autocomplete="current-password">
        </div>
        
        <button type="submit" id="loginButton">Sign In</button>
      </form>
    </div>
  </div>
  
  <!-- Admin Dashboard -->
  <div id="adminDashboard" class="container admin-dashboard">
    <div class="header">
      <h1>Book Management Dashboard</h1>
      <div class="user-info">
        <span id="userEmail"></span>
        <button id="logoutButton" class="btn-small">Logout</button>
      </div>
    </div>
    
    <div class="dashboard-grid">
      <div class="stat-card">
        <h3>Total Books</h3>
        <div class="value" id="totalBooks">0</div>
      </div>
      <div class="stat-card">
        <h3>Categories</h3>
        <div class="value" id="totalCategories">0</div>
      </div>
      <div class="stat-card">
        <h3>Fiction Books</h3>
        <div class="value" id="fictionBooks">0</div>
      </div>
      <div class="stat-card">
        <h3>Non-Fiction Books</h3>
        <div class="value" id="nonFictionBooks">0</div>
      </div>
    </div>
    
    <div class="tabs">
      <div class="tab active" data-tab="bookList">Book List</div>
      <div class="tab" data-tab="addBook">Add New Book</div>
    </div>
    
    <div id="statusMessage"></div>
    
    <div id="bookListTab" class="tab-content active">
      <div class="card">
        <h2>Book Collection</h2>
        <div id="booksTableContainer">
          <table class="table" id="booksTable">
            <thead>
              <tr>
                <th>Title</th>
                <th>Author</th>
                <th>Category</th>
                <th>Year</th>
                <th>Status</th>
                <th>Rating</th>
                <th>ISBN</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="booksTableBody">
              <!-- Books will be loaded here -->
              <tr>
                <td colspan="8" style="text-align: center;">No books found. Add some books to see them here.</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    
    <div id="addBookTab" class="tab-content">
      <div class="card">
        <h2>Add New Book</h2>
        
        <!-- Book Search Options -->
        <div class="search-options" style="margin-bottom: 20px;">
          <div style="display: flex; margin-bottom: 15px;">
            <button type="button" id="searchByIsbnBtn" class="search-tab active" style="flex: 1; padding: 8px; border: none; border-radius: 4px 0 0 4px; cursor: pointer; background-color: var(--primary-color); color: white;">Search by ISBN</button>
            <button type="button" id="searchByTitleBtn" class="search-tab" style="flex: 1; padding: 8px; border: none; border-radius: 0 4px 4px 0; cursor: pointer; background-color: #e5e7eb; color: var(--text-color);">Search by Title/Author</button>
          </div>
          
          <!-- ISBN Search -->
          <div id="isbnSearchContainer" class="search-container" style="margin-bottom: 20px;">
            <div style="display: flex;">
              <input type="text" id="isbnSearch" placeholder="Enter ISBN (e.g., 9780061122415)" style="flex-grow: 1; padding: 10px; border: 1px solid var(--border-color); border-radius: 4px 0 0 4px;">
              <button type="button" id="isbnSearchBtn" style="padding: 10px 15px; border: none; border-radius: 0 4px 4px 0; background-color: var(--primary-color); color: white; cursor: pointer;">Lookup</button>
            </div>
          </div>
          
          <!-- Title/Author Search -->
          <div id="titleSearchContainer" class="search-container" style="display: none; margin-bottom: 20px;">
            <div style="display: flex;">
              <input type="text" id="titleSearch" placeholder="Enter title or author name" style="flex-grow: 1; padding: 10px; border: 1px solid var(--border-color); border-radius: 4px 0 0 4px;">
              <button type="button" id="titleSearchBtn" style="padding: 10px 15px; border: none; border-radius: 0 4px 4px 0; background-color: var(--primary-color); color: white; cursor: pointer;">Search</button>
            </div>
          </div>
        </div>
        
        <!-- Search Results -->
        <div id="searchResults" style="display: none; max-height: 300px; overflow-y: auto; margin-bottom: 20px; border: 1px solid var(--border-color); border-radius: 4px;">
          <div id="searchResultsList"></div>
        </div>
        
        <!-- Book Preview -->
        <div id="bookPreview" style="display: none; margin-bottom: 20px; padding: 15px; background-color: #f8f9fa; border-radius: 4px;">
          <div style="display: flex; align-items: start;">
            <div id="bookPreviewCover" style="width: 80px; height: 120px; background-color: #ddd; margin-right: 15px; text-align: center; line-height: 120px; font-size: 10px;">No Cover</div>
            <div>
              <h3 id="bookPreviewTitle" style="margin: 0 0 5px 0; font-size: 18px;">Book Title</h3>
              <p id="bookPreviewAuthor" style="margin: 0 0 5px 0; font-size: 14px; color: #666;">Author Name</p>
              <p id="bookPreviewPublisher" style="margin: 0; font-size: 12px; color: #666;">Publisher, Year</p>
              <p id="bookPreviewIsbn" style="margin: 5px 0 0 0; font-size: 12px; color: #666;">ISBN: 1234567890</p>
            </div>
          </div>
          <div id="bookPreviewDescription" style="margin-top: 15px; font-size: 14px; max-height: 100px; overflow-y: auto;"></div>
        </div>
        
        <!-- Manual Book Form -->
        <form id="bookForm" class="book-form">
          <div class="form-group">
            <label for="title">Title</label>
            <input type="text" id="title" required>
          </div>
          
          <div class="form-group">
            <label for="author">Author</label>
            <input type="text" id="author" required>
          </div>
          
          <div class="form-group">
            <label for="category">Category</label>
            <input type="text" id="category" required placeholder="e.g. Fiction, Science, History">
          </div>
          
          <div class="form-group">
            <label for="year">Year Published</label>
            <input type="number" id="year" required min="1000" max="2100">
          </div>
          
          <div class="form-group">
            <label for="status">Reading Status</label>
            <select id="status" required style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 4px;">
              <option value="read">Read</option>
              <option value="reading">Currently Reading</option>
              <option value="toRead">Want to Read</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="userRating">My Rating</label>
            <div style="display: flex; align-items: center;">
              <select id="userRating" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 4px;">
                <option value="">-- Select Rating --</option>
                <option value="5">★★★★★ (5/5) - Excellent</option>
                <option value="4">★★★★☆ (4/5) - Very Good</option>
                <option value="3">★★★☆☆ (3/5) - Good</option>
                <option value="2">★★☆☆☆ (2/5) - Fair</option>
                <option value="1">★☆☆☆☆ (1/5) - Poor</option>
              </select>
            </div>
          </div>
          
          <div class="form-group">
            <label for="notes">My Notes & Review</label>
            <textarea id="notes" rows="4" style="padding: 10px; border: 1px solid var(--border-color); border-radius: 4px;" placeholder="Your personal thoughts, reviews, or notes about the book..."></textarea>
          </div>
          
          <div class="form-group">
            <label for="description">Book Description</label>
            <textarea id="description" rows="4" style="padding: 10px; border: 1px solid var(--border-color); border-radius: 4px;"></textarea>
          </div>
          
          <div class="form-group">
            <label for="coverImage">Cover Image URL</label>
            <input type="url" id="coverImage" placeholder="https://example.com/book-cover.jpg">
          </div>
          
          <input type="hidden" id="bookId">
          <input type="hidden" id="bookIsbn">
          <button type="submit" id="saveBookButton">Save Book</button>
        </form>
      </div>
    </div>
  </div>
  
  <!-- Add Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  
  <!-- Load secure configuration with multiple path attempts -->
  <script>
    // Try to load secure-config.js with different paths
    function loadSecureConfig() {
      const possiblePaths = [
        'secure-config.js',
        '/personalsite/secure-config.js',
        '../secure-config.js'
      ];
      
      let loaded = false;
      
      possiblePaths.forEach(path => {
        if (!loaded) {
          const script = document.createElement('script');
          script.src = path;
          script.onload = () => {
            console.log('Successfully loaded secure config from:', path);
            loaded = true;
          };
          script.onerror = () => {
            console.warn('Failed to load secure config from:', path);
          };
          document.head.appendChild(script);
        }
      });
    }
    
    // Initialize loading
    loadSecureConfig();
  </script>
  
  <script>
    // Get base path from URL or secure config
    function getBasePath() {
      // First try to get from secure config
      if (window.SECURE_CONFIG && window.SECURE_CONFIG.basePath) {
        return window.SECURE_CONFIG.basePath;
      }
      
      // Fallback to path detection
      if (window.location.hostname.includes('github.io')) {
        const pathMatch = window.location.pathname.match(/^\/([^/]+)/);
        if (pathMatch) {
          return pathMatch[0];
        }
      }
      return '/personalsite'; // Default fallback
    }
    
    // Show error message for debugging purposes
    console.log('Direct Admin Page - Current path:', window.location.pathname);
    console.log('Direct Admin Page - Base path:', getBasePath());
    
    // Verify if secure config loaded
    if (!window.SECURE_CONFIG) {
      console.warn('Secure config not loaded, using fallback configuration');
    }
    
    // Get Firebase Configuration from secure config or use fallback for direct testing
    const firebaseConfig = window.SECURE_CONFIG ? window.SECURE_CONFIG.firebase : {
      apiKey: "AIzaSyD4a8iaxHP9xPGV5tR5LwvzDVa5Y9o5wGQ",
      authDomain: "personalsite-19189.firebaseapp.com",
      projectId: "personalsite-19189",
      storageBucket: "personalsite-19189.appspot.com",
      messagingSenderId: "892517360036",
      appId: "1:892517360036:web:36dda234d9f3f79562e131"
    };
    
    // Get Google Books API configuration
    const googleBooksConfig = window.SECURE_CONFIG && window.SECURE_CONFIG.googleBooks ? window.SECURE_CONFIG.googleBooks : {
      apiKey: "" // No fallback key for Google Books API
    };
    
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    
    // DOM Elements
    const loginPage = document.getElementById('loginPage');
    const loginForm = document.getElementById('loginForm');
    const loginButton = document.getElementById('loginButton');
    const loginError = document.getElementById('loginError');
    const errorText = document.getElementById('errorText');
    
    const adminDashboard = document.getElementById('adminDashboard');
    const logoutButton = document.getElementById('logoutButton');
    const userEmail = document.getElementById('userEmail');
    
    const statusMessage = document.getElementById('statusMessage');
    const totalBooks = document.getElementById('totalBooks');
    const totalCategories = document.getElementById('totalCategories');
    const fictionBooks = document.getElementById('fictionBooks');
    const nonFictionBooks = document.getElementById('nonFictionBooks');
    
    const tabs = document.querySelectorAll('.tab');
    const tabContents = document.querySelectorAll('.tab-content');
    
    const bookForm = document.getElementById('bookForm');
    const booksTableBody = document.getElementById('booksTableBody');
    
    // Book collection reference
    const booksCollection = db.collection('books');
    
    // Check auth state
    auth.onAuthStateChanged(function(user) {
      if (user) {
        // User is signed in
        loginPage.style.display = 'none';
        adminDashboard.style.display = 'block';
        userEmail.textContent = user.email;
        
        // Load books data
        loadBooks();
        updateStats();
      } else {
        // No user is signed in
        loginPage.style.display = 'block';
        adminDashboard.style.display = 'none';
      }
    });
    
    // Login form submit handler
    loginForm.addEventListener('submit', function(e) {
      e.preventDefault();
      
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      
      loginButton.textContent = 'Signing in...';
      loginButton.disabled = true;
      loginError.classList.add('hidden');
      
      auth.signInWithEmailAndPassword(email, password)
        .then(function(userCredential) {
          // Store auth in session storage
          sessionStorage.setItem('auth_success', 'true');
          sessionStorage.setItem('auth_timestamp', new Date().toISOString());
        })
        .catch(function(error) {
          // Show error message
          errorText.textContent = error.message;
          loginError.classList.remove('hidden');
          
          // Reset button
          loginButton.textContent = 'Sign In';
          loginButton.disabled = false;
        });
    });
    
    // No bypass authentication
    
    // Logout button click handler
    logoutButton.addEventListener('click', function() {
      auth.signOut().then(function() {
        // Clear session storage
        sessionStorage.removeItem('auth_success');
        sessionStorage.removeItem('auth_timestamp');
        
        // Update UI
        loginPage.style.display = 'block';
        adminDashboard.style.display = 'none';
      });
    });
    
    // Tab switching
    tabs.forEach(function(tab) {
      tab.addEventListener('click', function() {
        // Remove active class from all tabs and contents
        tabs.forEach(t => t.classList.remove('active'));
        tabContents.forEach(c => c.classList.remove('active'));
        
        // Add active class to clicked tab and corresponding content
        this.classList.add('active');
        document.getElementById(this.dataset.tab + 'Tab').classList.add('active');
      });
    });
    
    // Book form submit handler
    bookForm.addEventListener('submit', function(e) {
      e.preventDefault();
      
      const bookId = document.getElementById('bookId').value;
      const title = document.getElementById('title').value;
      const author = document.getElementById('author').value;
      const category = document.getElementById('category').value;
      const year = parseInt(document.getElementById('year').value);
      const description = document.getElementById('description').value;
      const coverImage = document.getElementById('coverImage').value;
      const isbn = document.getElementById('bookIsbn').value;
      const status = document.getElementById('status').value;
      const userRating = document.getElementById('userRating').value ? parseInt(document.getElementById('userRating').value) : null;
      const notes = document.getElementById('notes').value;
      
      const bookData = {
        title,
        author,
        category,
        year,
        description: description || '',
        coverImage: coverImage || '',
        isbn: isbn || '',
        status: status || 'toRead',
        userRating,
        notes: notes || '',
        updatedAt: new Date()
      };
      
      if (bookId) {
        // Update existing book
        booksCollection.doc(bookId).update(bookData)
          .then(function() {
            showMessage('Book updated successfully!', 'success');
            resetBookForm();
            loadBooks();
            updateStats();
            
            // Switch to book list tab
            tabs.forEach(t => t.classList.remove('active'));
            tabContents.forEach(c => c.classList.remove('active'));
            document.querySelector('[data-tab="bookList"]').classList.add('active');
            document.getElementById('bookListTab').classList.add('active');
          })
          .catch(function(error) {
            showMessage('Error updating book: ' + error.message, 'error');
          });
      } else {
        // Add created date for new books
        bookData.createdAt = new Date();
        
        // Add new book
        booksCollection.add(bookData)
          .then(function() {
            showMessage('Book added successfully!', 'success');
            resetBookForm();
            loadBooks();
            updateStats();
            
            // Switch to book list tab
            tabs.forEach(t => t.classList.remove('active'));
            tabContents.forEach(c => c.classList.remove('active'));
            document.querySelector('[data-tab="bookList"]').classList.add('active');
            document.getElementById('bookListTab').classList.add('active');
          })
          .catch(function(error) {
            showMessage('Error adding book: ' + error.message, 'error');
          });
      }
    });
    
    // Load books function
    function loadBooks() {
      booksCollection.orderBy('title').get()
        .then(function(querySnapshot) {
          if (querySnapshot.empty) {
            booksTableBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">No books found. Add some books to see them here.</td></tr>';
            return;
          }
          
          let booksHTML = '';
          querySnapshot.forEach(function(doc) {
            const book = doc.data();
            // Format the status display
            let statusDisplay = '';
            if (book.status === 'read') statusDisplay = 'Read';
            else if (book.status === 'reading') statusDisplay = 'Reading';
            else if (book.status === 'toRead') statusDisplay = 'To Read';
            else statusDisplay = book.status || '-';
            
            // Format the rating display with stars
            let ratingDisplay = '';
            if (book.userRating) {
              const stars = '★'.repeat(book.userRating) + '☆'.repeat(5 - book.userRating);
              ratingDisplay = `${stars} (${book.userRating}/5)`;
            } else {
              ratingDisplay = '-';
            }
            
            booksHTML += `
              <tr>
                <td>${book.title}</td>
                <td>${book.author}</td>
                <td>${book.category}</td>
                <td>${book.year}</td>
                <td>${statusDisplay}</td>
                <td>${ratingDisplay}</td>
                <td>${book.isbn || '-'}</td>
                <td class="action-buttons">
                  <button class="btn-small btn-edit" data-id="${doc.id}">Edit</button>
                  <button class="btn-small btn-delete" data-id="${doc.id}">Delete</button>
                </td>
              </tr>
            `;
          });
          
          booksTableBody.innerHTML = booksHTML;
          
          // Add event listeners to edit and delete buttons
          document.querySelectorAll('.btn-edit').forEach(function(button) {
            button.addEventListener('click', function() {
              editBook(this.dataset.id);
            });
          });
          
          document.querySelectorAll('.btn-delete').forEach(function(button) {
            button.addEventListener('click', function() {
              deleteBook(this.dataset.id);
            });
          });
        })
        .catch(function(error) {
          showMessage('Error loading books: ' + error.message, 'error');
        });
    }
    
    // Edit book function
    function editBook(id) {
      booksCollection.doc(id).get()
        .then(function(doc) {
          if (doc.exists) {
            const book = doc.data();
            
            // Fill form with book data
            document.getElementById('bookId').value = id;
            document.getElementById('title').value = book.title;
            document.getElementById('author').value = book.author;
            document.getElementById('category').value = book.category;
            document.getElementById('year').value = book.year;
            document.getElementById('description').value = book.description || '';
            document.getElementById('coverImage').value = book.coverImage || '';
            document.getElementById('bookIsbn').value = book.isbn || '';
            
            // Set status
            const statusSelect = document.getElementById('status');
            if (book.status) {
              // Find the option with the matching value
              for (let i = 0; i < statusSelect.options.length; i++) {
                if (statusSelect.options[i].value === book.status) {
                  statusSelect.selectedIndex = i;
                  break;
                }
              }
            }
            
            // Set rating
            const ratingSelect = document.getElementById('userRating');
            if (book.userRating) {
              // Find the option with the matching value
              for (let i = 0; i < ratingSelect.options.length; i++) {
                if (ratingSelect.options[i].value === book.userRating.toString()) {
                  ratingSelect.selectedIndex = i;
                  break;
                }
              }
            } else {
              ratingSelect.selectedIndex = 0;
            }
            
            // Set notes
            document.getElementById('notes').value = book.notes || '';
            
            // Also update book preview if needed
            if (book.coverImage || book.description) {
              const previewData = {
                title: book.title,
                authors: [book.author],
                publisher: '',
                publishedDate: book.year ? book.year.toString() : '',
                description: book.description || '',
                imageLinks: book.coverImage ? { thumbnail: book.coverImage } : undefined
              };
              populateBookPreview(previewData, book.isbn || '');
            } else {
              document.getElementById('bookPreview').style.display = 'none';
            }
            
            // Switch to add book tab
            tabs.forEach(t => t.classList.remove('active'));
            tabContents.forEach(c => c.classList.remove('active'));
            document.querySelector('[data-tab="addBook"]').classList.add('active');
            document.getElementById('addBookTab').classList.add('active');
            
            // Change button text
            document.getElementById('saveBookButton').textContent = 'Update Book';
          } else {
            showMessage('Book not found', 'error');
          }
        })
        .catch(function(error) {
          showMessage('Error loading book: ' + error.message, 'error');
        });
    }
    
    // Delete book function
    function deleteBook(id) {
      if (confirm('Are you sure you want to delete this book?')) {
        booksCollection.doc(id).delete()
          .then(function() {
            showMessage('Book deleted successfully!', 'success');
            loadBooks();
            updateStats();
          })
          .catch(function(error) {
            showMessage('Error deleting book: ' + error.message, 'error');
          });
      }
    }
    
    // Reset book form
    function resetBookForm() {
      document.getElementById('bookId').value = '';
      document.getElementById('bookIsbn').value = '';
      bookForm.reset();
      
      // Reset select elements to defaults
      document.getElementById('status').selectedIndex = 2; // toRead by default
      document.getElementById('userRating').selectedIndex = 0; // No rating by default
      
      document.getElementById('saveBookButton').textContent = 'Save Book';
      document.getElementById('bookPreview').style.display = 'none';
      document.getElementById('searchResults').style.display = 'none';
    }
    
    // Update statistics
    function updateStats() {
      booksCollection.get()
        .then(function(querySnapshot) {
          const books = [];
          const categories = new Set();
          let fiction = 0;
          let nonFiction = 0;
          
          querySnapshot.forEach(function(doc) {
            const book = doc.data();
            books.push(book);
            categories.add(book.category.toLowerCase());
            
            // Count fiction vs non-fiction (simplified)
            if (book.category.toLowerCase().includes('fiction')) {
              fiction++;
            } else {
              nonFiction++;
            }
          });
          
          totalBooks.textContent = books.length;
          totalCategories.textContent = categories.size;
          fictionBooks.textContent = fiction;
          nonFictionBooks.textContent = nonFiction;
        })
        .catch(function(error) {
          console.error('Error updating stats:', error);
        });
    }
    
    // Show message function
    function showMessage(message, type) {
      statusMessage.textContent = message;
      statusMessage.className = '';
      statusMessage.classList.add('alert', `alert-${type}`);
      statusMessage.style.display = 'block';
      
      // Hide message after 3 seconds
      setTimeout(function() {
        statusMessage.style.display = 'none';
      }, 3000);
    }
    
    // Google Books API Integration
    
    // Search tab handling
    const searchByIsbnBtn = document.getElementById('searchByIsbnBtn');
    const searchByTitleBtn = document.getElementById('searchByTitleBtn');
    const isbnSearchContainer = document.getElementById('isbnSearchContainer');
    const titleSearchContainer = document.getElementById('titleSearchContainer');
    
    searchByIsbnBtn.addEventListener('click', function() {
      searchByIsbnBtn.style.backgroundColor = 'var(--primary-color)';
      searchByIsbnBtn.style.color = 'white';
      searchByTitleBtn.style.backgroundColor = '#e5e7eb';
      searchByTitleBtn.style.color = 'var(--text-color)';
      isbnSearchContainer.style.display = 'block';
      titleSearchContainer.style.display = 'none';
      document.getElementById('searchResults').style.display = 'none';
    });
    
    searchByTitleBtn.addEventListener('click', function() {
      searchByTitleBtn.style.backgroundColor = 'var(--primary-color)';
      searchByTitleBtn.style.color = 'white';
      searchByIsbnBtn.style.backgroundColor = '#e5e7eb';
      searchByIsbnBtn.style.color = 'var(--text-color)';
      titleSearchContainer.style.display = 'block';
      isbnSearchContainer.style.display = 'none';
      document.getElementById('searchResults').style.display = 'none';
    });
    
    // ISBN Search
    const isbnSearchBtn = document.getElementById('isbnSearchBtn');
    const isbnSearchInput = document.getElementById('isbnSearch');
    
    isbnSearchBtn.addEventListener('click', function() {
      const isbn = isbnSearchInput.value.trim();
      if (!isbn) {
        showMessage('Please enter an ISBN', 'error');
        return;
      }
      
      isbnSearchBtn.disabled = true;
      isbnSearchBtn.textContent = 'Searching...';
      
      // Get Google Books API key from secure config if available
      const apiKey = googleBooksConfig && googleBooksConfig.apiKey ? 
        `&key=${googleBooksConfig.apiKey}` : '';
      
      // Fetch book data from Google Books API
      fetch(`https://www.googleapis.com/books/v1/volumes?q=isbn:${isbn}${apiKey}`)
        .then(response => {
          if (!response.ok) {
            throw new Error(`Google Books API error: ${response.statusText}`);
          }
          return response.json();
        })
        .then(data => {
          isbnSearchBtn.disabled = false;
          isbnSearchBtn.textContent = 'Lookup';
          
          if (!data.items || data.items.length === 0) {
            showMessage('No books found with this ISBN. Please check and try again.', 'error');
            return;
          }
          
          // Get the first result
          const book = data.items[0].volumeInfo;
          populateBookPreview(book, isbn);
          populateBookForm(book, isbn);
        })
        .catch(error => {
          console.error('Error searching by ISBN:', error);
          showMessage('Error looking up book. Please try again.', 'error');
          isbnSearchBtn.disabled = false;
          isbnSearchBtn.textContent = 'Lookup';
        });
    });
    
    // Title/Author Search
    const titleSearchBtn = document.getElementById('titleSearchBtn');
    const titleSearchInput = document.getElementById('titleSearch');
    const searchResults = document.getElementById('searchResults');
    const searchResultsList = document.getElementById('searchResultsList');
    
    titleSearchBtn.addEventListener('click', function() {
      const query = titleSearchInput.value.trim();
      if (!query) {
        showMessage('Please enter a search term', 'error');
        return;
      }
      
      titleSearchBtn.disabled = true;
      titleSearchBtn.textContent = 'Searching...';
      
      // Get Google Books API key from secure config if available
      const apiKey = googleBooksConfig && googleBooksConfig.apiKey ? 
        `&key=${googleBooksConfig.apiKey}` : '';
      
      // Fetch book data from Google Books API
      fetch(`https://www.googleapis.com/books/v1/volumes?q=${encodeURIComponent(query)}&maxResults=10${apiKey}`)
        .then(response => {
          if (!response.ok) {
            throw new Error(`Google Books API error: ${response.statusText}`);
          }
          return response.json();
        })
        .then(data => {
          titleSearchBtn.disabled = false;
          titleSearchBtn.textContent = 'Search';
          
          if (!data.items || data.items.length === 0) {
            showMessage('No books found. Please try a different search term.', 'error');
            return;
          }
          
          // Display search results
          displaySearchResults(data.items);
        })
        .catch(error => {
          console.error('Error searching books:', error);
          showMessage('Error searching books. Please try again.', 'error');
          titleSearchBtn.disabled = false;
          titleSearchBtn.textContent = 'Search';
        });
    });
    
    // Display search results
    function displaySearchResults(books) {
      searchResultsList.innerHTML = '';
      
      books.forEach(item => {
        const book = item.volumeInfo;
        const industryIdentifiers = book.industryIdentifiers || [];
        const isbn = industryIdentifiers.find(id => id.type === 'ISBN_13')?.identifier || 
                    industryIdentifiers.find(id => id.type === 'ISBN_10')?.identifier || '';
        
        const resultItem = document.createElement('div');
        resultItem.className = 'result-item';
        resultItem.style.padding = '10px';
        resultItem.style.borderBottom = '1px solid var(--border-color)';
        resultItem.style.cursor = 'pointer';
        resultItem.style.display = 'flex';
        resultItem.style.alignItems = 'start';
        
        // Book cover
        const coverContainer = document.createElement('div');
        coverContainer.style.width = '50px';
        coverContainer.style.height = '75px';
        coverContainer.style.marginRight = '10px';
        coverContainer.style.backgroundColor = '#ddd';
        coverContainer.style.display = 'flex';
        coverContainer.style.alignItems = 'center';
        coverContainer.style.justifyContent = 'center';
        
        if (book.imageLinks && book.imageLinks.thumbnail) {
          const cover = document.createElement('img');
          cover.src = book.imageLinks.thumbnail;
          cover.style.width = '100%';
          cover.style.height = '100%';
          cover.style.objectFit = 'cover';
          coverContainer.appendChild(cover);
        } else {
          coverContainer.textContent = 'No Cover';
          coverContainer.style.fontSize = '8px';
          coverContainer.style.textAlign = 'center';
        }
        
        // Book info
        const infoContainer = document.createElement('div');
        infoContainer.style.flex = '1';
        
        const title = document.createElement('div');
        title.textContent = book.title;
        title.style.fontWeight = 'bold';
        title.style.fontSize = '14px';
        
        const author = document.createElement('div');
        author.textContent = book.authors ? book.authors.join(', ') : 'Unknown Author';
        author.style.fontSize = '12px';
        
        const year = document.createElement('div');
        year.textContent = book.publishedDate ? book.publishedDate.substring(0, 4) : '';
        year.style.fontSize = '10px';
        year.style.color = '#666';
        
        infoContainer.appendChild(title);
        infoContainer.appendChild(author);
        infoContainer.appendChild(year);
        
        resultItem.appendChild(coverContainer);
        resultItem.appendChild(infoContainer);
        
        // Add click handler
        resultItem.addEventListener('click', function() {
          populateBookPreview(book, isbn);
          populateBookForm(book, isbn);
          searchResults.style.display = 'none';
        });
        
        searchResultsList.appendChild(resultItem);
      });
      
      searchResults.style.display = 'block';
    }
    
    // Populate book preview
    function populateBookPreview(book, isbn) {
      const bookPreview = document.getElementById('bookPreview');
      const bookPreviewTitle = document.getElementById('bookPreviewTitle');
      const bookPreviewAuthor = document.getElementById('bookPreviewAuthor');
      const bookPreviewPublisher = document.getElementById('bookPreviewPublisher');
      const bookPreviewIsbn = document.getElementById('bookPreviewIsbn');
      const bookPreviewDescription = document.getElementById('bookPreviewDescription');
      const bookPreviewCover = document.getElementById('bookPreviewCover');
      
      bookPreviewTitle.textContent = book.title || 'Unknown Title';
      bookPreviewAuthor.textContent = book.authors ? book.authors.join(', ') : 'Unknown Author';
      bookPreviewPublisher.textContent = `${book.publisher || 'Unknown Publisher'}${book.publishedDate ? ', ' + book.publishedDate : ''}`;
      bookPreviewIsbn.textContent = `ISBN: ${isbn || 'Unknown'}`;
      
      // Set description
      bookPreviewDescription.textContent = book.description || 'No description available';
      
      // If we have Google ratings, add them to the description
      if (book.averageRating) {
        const googleRating = '★'.repeat(Math.round(book.averageRating)) + 
                             '☆'.repeat(5 - Math.round(book.averageRating));
        const ratingsInfo = `\n\nGoogle Rating: ${googleRating} (${book.averageRating}/5 from ${book.ratingsCount} ratings)`;
        bookPreviewDescription.textContent += ratingsInfo;
      }
      
      // Handle cover image
      if (book.imageLinks && book.imageLinks.thumbnail) {
        bookPreviewCover.innerHTML = `<img src="${book.imageLinks.thumbnail}" alt="Book cover" style="width: 100%; height: 100%; object-fit: cover;">`;
      } else {
        bookPreviewCover.innerHTML = 'No Cover';
      }
      
      bookPreview.style.display = 'block';
    }
    
    // Populate book form
    function populateBookForm(book, isbn) {
      document.getElementById('title').value = book.title || '';
      document.getElementById('author').value = book.authors ? book.authors.join(', ') : '';
      document.getElementById('category').value = book.categories ? book.categories[0] : '';
      document.getElementById('year').value = book.publishedDate ? book.publishedDate.substring(0, 4) : '';
      document.getElementById('description').value = book.description || '';
      document.getElementById('coverImage').value = book.imageLinks && book.imageLinks.thumbnail ? book.imageLinks.thumbnail : '';
      document.getElementById('bookIsbn').value = isbn || '';
      
      // Set default status to "Want to Read" for new books
      const statusSelect = document.getElementById('status');
      statusSelect.value = 'toRead';
      
      // Reset notes and rating for new books
      document.getElementById('notes').value = '';
      document.getElementById('userRating').selectedIndex = 0;
    }
    
    // Add event listeners for enter key in search inputs
    isbnSearchInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        isbnSearchBtn.click();
      }
    });
    
    titleSearchInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        titleSearchBtn.click();
      }
    });
  </script>
</body>
</html>